
<VirtualHost *:80>
    ServerName sifas-cards.sonaza.com
    Redirect permanent / https://sifas-cards.sonaza.com/
    
    ErrorLog ${APACHE_LOG_DIR}/sites/sifas-cards.sonaza.com/error.log
    CustomLog ${APACHE_LOG_DIR}/sites/sifas-cards.sonaza.com/access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName sifas-cards.sonaza.com
    DocumentRoot /var/www/sonaza.com/sifas-cards.subdomain/dist/public/
    
    Use php-fpm 8.2
    Use LetsEncryptCertificates sonaza.com
    
    Include /etc/apache2/maxmind-conf/maxmind-geoip.conf
    
    ErrorLog ${APACHE_LOG_DIR}/sites/sifas-cards.sonaza.com/error.log
    CustomLog ${APACHE_LOG_DIR}/sites/sifas-cards.sonaza.com/access.log combined
    
    Alias "/dist" "/var/www/sonaza.com/sifas-cards.subdomain/dist/build-live"
    
    Redirect 301 /index.html /
    
    Options +FollowSymLinks -MultiViews -Indexes
    FileETag None
    
    ErrorDocument 400 /error/400.html
    ErrorDocument 403 /error/403.html
    ErrorDocument 404 /error/404.html
    ErrorDocument 410 /error/410.html
    ErrorDocument 500 /error/500.html
    ErrorDocument 503 /error/503.html
    
    <Directory "/var/www/sonaza.com/sifas-cards.subdomain/dist/build-live/">
        AllowOverride All
        Require all granted
        
        <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # Removes cache busting token from resource files
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^(css|js)/(.+)\.([a-z0-9]{6})\.(css|js)$ $1/$2.$4 [L]
            RewriteRule ^(thumbnails)/(.+)\.([a-z0-9]{6})\.(jpe?g|png|webp)$ $1/$2.$4 [L]
            RewriteRule ^(pages)/(.+)\.([a-z0-9]{6})\.(html)$ $1/$2.$4 [L]
            RewriteRule ^(pages/(.+))/(.+)\.([a-z0-9]{6})\.(html)$ $1/$2.$4 [L]
            
        </IfModule>
    </Directory>
    
    <Directory "/var/www/sonaza.com/sifas-cards.subdomain/dist/public/">
        AllowOverride All
        Require all granted
    </Directory>
    
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteCond %{REQUEST_URI} "!(^|/)\.well-known/([^./]+./?)+$" [NC]
        RewriteCond %{SCRIPT_FILENAME} -d [OR]
        RewriteCond %{SCRIPT_FILENAME} -f
        RewriteRule "(^|/)\." - [F]
        
        # Removes cache busting token from resource files
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^(css|js)/(.+)\.([a-z0-9]{6})\.(css|js)$ $1/$2.$4 [L]
        
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteRule ^crawler.html$ dist/pages/crawler.html$1 [L]
        
        <IfModule mod_maxminddb.c>
            RewriteCond %{REQUEST_FILENAME} -f
            RewriteCond %{ENV:MM_COUNTRY_CODE} ^(CL)$
            RewriteRule ^img/yay-hd/(.+)$ img/yay/$1 [L]
        </IfModule>
        
        RewriteCond %{THE_REQUEST} ^GET.*index\.php [NC]
        RewriteRule (.*?)index\.php/*(.*) /$1$2 [R=301,NE,L]
        
    </IfModule>
    
    <IfModule mod_setenvif.c>
        <IfModule mod_headers.c>
            <FilesMatch "\.(bmp|cur|gif|ico|jpe?g|png|svgz?|webp)$">
                SetEnvIf Origin ":" IS_CORS
                Header set Access-Control-Allow-Origin "*" env=IS_CORS
            </FilesMatch>
            <FilesMatch "\.(eot|otf|tt[cf]|woff2?)$">
                Header set Access-Control-Allow-Origin "*"
            </FilesMatch>
        </IfModule>
    </IfModule>

    <IfModule mod_headers.c>
        Header set X-Best-Girl "Nozomi"
        
        Header set Access-Control-Allow-Origin "*"
        
        Header set Expect-CT "max-age=0"
        Header set Feature-Policy "geolocation 'none'; microphone 'none' "
        Header set Permissions-Policy "geolocation=(), microphone=()"
        
        Header set X-Content-Type-Options "nosniff"
        # Header add X-Robots-Tag "noindex"
        
        Header unset X-Powered-By
        Header unset ETag
        
        Header set X-UA-Compatible "IE=edge"
        <FilesMatch "\.(appcache|atom|bbaw|bmp|br|crx|css|cur|eot|f4[abpv]|flv|geojson|gif|gz|htc|ic[os]|jpe?g|m?js|json(ld)?|m4[av]|manifest|map|markdown|md|mp4|oex|og[agv]|opus|otf|pdf|png|rdf|rss|safariextz|svgz?|swf|topojson|tt[cf]|txt|vcard|vcf|vtt|wasm|webapp|web[mp]|webmanifest|woff2?|xloc|xml|xpi)$">
            Header unset X-UA-Compatible
        </FilesMatch> 
        
        Header set Referrer-Policy "no-referrer-when-downgrade"
        <FilesMatch "\.(appcache|atom|bbaw|bmp|br|crx|css|cur|eot|f4[abpv]|flv|geojson|gif|gz|htc|ic[os]|jpe?g|m?js|json(ld)?|m4[av]|manifest|map|markdown|md|mp4|oex|og[agv]|opus|otf|pdf|png|rdf|rss|safariextz|svgz?|swf|topojson|tt[cf]|txt|vcard|vcf|vtt|wasm|webapp|web[mp]|webmanifest|woff2?|xloc|xml|xpi)$">
            Header unset Referrer-Policy
        </FilesMatch>
        
        Header set X-Frame-Options "SAMEORIGIN"
        <FilesMatch "\.(appcache|atom|bbaw|bmp|br|crx|css|cur|eot|f4[abpv]|flv|geojson|gif|gz|htc|ic[os]|jpe?g|m?js|json(ld)?|m4[av]|manifest|map|markdown|md|mp4|oex|og[agv]|opus|otf|pdf|png|rdf|rss|safariextz|svgz?|swf|topojson|tt[cf]|txt|vcard|vcf|vtt|wasm|webapp|web[mp]|webmanifest|woff2?|xloc|xml|xpi)$">
            Header unset X-Frame-Options
        </FilesMatch>
    </IfModule>
    
    <IfModule mod_authz_core.c>
        <FilesMatch "(^#.*#|\.(bak|conf|dist|fla|in[ci]|log|orig|psd|sh|sql|sw[op])|~)$">
            Require all denied
        </FilesMatch>
    </IfModule>

    <IfModule mod_deflate.c>
        <FilesMatch "\.(html?|txt|css|js|php|pl)$">
            SetOutputFilter DEFLATE
        </FilesMatch>
    </IfModule>

    <IfModule mod_expires.c>

        AddType font/otf                         otf
        AddType font/ttf                         ttf
        AddType application/font-woff            woff
        AddType application/font-woff2           woff2
        AddType application/vnd.ms-fontobject    eot
        
        AddType image/webp                       webp

        ExpiresActive on
        ExpiresDefault                                      "access plus 1 month"

      # CSS

        ExpiresByType text/css                              "access plus 1 year"


      # Data interchange

        ExpiresByType application/atom+xml                  "access plus 1 hour"
        ExpiresByType application/rdf+xml                   "access plus 1 hour"
        ExpiresByType application/rss+xml                   "access plus 1 hour"

        ExpiresByType application/json                      "access plus 0 seconds"
        ExpiresByType application/ld+json                   "access plus 0 seconds"
        ExpiresByType application/schema+json               "access plus 0 seconds"
        ExpiresByType application/vnd.geo+json              "access plus 0 seconds"
        ExpiresByType application/xml                       "access plus 0 seconds"
        ExpiresByType text/calendar                         "access plus 0 seconds"
        ExpiresByType text/xml                              "access plus 0 seconds"


      # Favicon (cannot be renamed!) and cursor images

        ExpiresByType image/vnd.microsoft.icon              "access plus 1 week"
        ExpiresByType image/x-icon                          "access plus 1 week"

      # HTML

        ExpiresByType text/html                             "access plus 0 seconds"


      # JavaScript

        ExpiresByType application/javascript                "access plus 1 year"
        ExpiresByType application/x-javascript              "access plus 1 year"
        ExpiresByType text/javascript                       "access plus 1 year"


      # Manifest files

        ExpiresByType application/manifest+json             "access plus 1 week"
        ExpiresByType application/x-web-app-manifest+json   "access plus 0 seconds"
        ExpiresByType text/cache-manifest                   "access plus 0 seconds"


      # Markdown

        ExpiresByType text/markdown                         "access plus 0 seconds"


      # Media files

        ExpiresByType audio/ogg                             "access plus 1 month"
        ExpiresByType audio/mpeg                            "access plus 1 month"
        ExpiresByType image/bmp                             "access plus 1 year"
        ExpiresByType image/gif                             "access plus 1 year"
        ExpiresByType image/jpeg                            "access plus 1 year"
        ExpiresByType image/png                             "access plus 1 year"
        ExpiresByType image/svg+xml                         "access plus 1 year"
        ExpiresByType image/webp                            "access plus 1 year"
        ExpiresByType video/mp4                             "access plus 1 month"
        ExpiresByType video/ogg                             "access plus 1 month"
        ExpiresByType video/webm                            "access plus 1 month"


      # WebAssembly

        ExpiresByType application/wasm                      "access plus 1 year"


      # Web fonts

        # Collection
        ExpiresByType font/collection                       "access plus 1 year"

        # Embedded OpenType (EOT)
        ExpiresByType application/vnd.ms-fontobject         "access plus 1 year"
        ExpiresByType font/eot                              "access plus 1 year"

        # OpenType
        ExpiresByType font/opentype                         "access plus 1 year"
        ExpiresByType font/otf                              "access plus 1 year"

        # TrueType
        ExpiresByType application/x-font-ttf                "access plus 1 year"
        ExpiresByType font/ttf                              "access plus 1 year"

        # Web Open Font Format (WOFF) 1.0
        ExpiresByType application/font-woff                 "access plus 1 year"
        ExpiresByType application/x-font-woff               "access plus 1 year"
        ExpiresByType font/woff                             "access plus 1 year"

        # Web Open Font Format (WOFF) 2.0
        ExpiresByType application/font-woff2                "access plus 1 year"
        ExpiresByType font/woff2                            "access plus 1 year"

      # Other
        ExpiresByType text/x-cross-domain-policy            "access plus 1 week"

    </IfModule>
</VirtualHost>
